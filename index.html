<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BFDI: Night Shift - Final Logic</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { 
            --neon: #00ff41; 
            --noise-op: 0.60;
            --tablet-speed: 0.5s cubic-bezier(0.1, 0.8, 0.2, 1);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; margin: 0; padding: 0; }
        body, html { width: 100%; height: 100%; background: #000; overflow: hidden; font-family: 'Courier New', monospace; color: white; }

        /* --- PRELOADER & SETUP --- */
        #loading-screen { position: fixed; inset: 0; z-index: 10000; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .progress-bar { width: 300px; height: 10px; border: 1px solid var(--neon); margin-top: 20px; position: relative; }
        #progress-fill { width: 0%; height: 100%; background: var(--neon); transition: width 0.3s; }

        #setup-menu { position: fixed; inset: 0; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #050505; transition: opacity 1s; }
        .fade-out { opacity: 0; pointer-events: none; }
        .fade-in { animation: fadeIn 1s forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- GAMEPLAY --- */
        #game-view { display: none; width: 100vw; height: 100vh; position: relative; }
        #office { position: absolute; inset: 0; background-size: 100% 100%; z-index: 10; }
        #noise { position: absolute; inset: 0; z-index: 45; pointer-events: none; opacity: var(--noise-op); mix-blend-mode: screen; }
        .clock { position: absolute; top: 30px; left: 30px; z-index: 100; font-size: 5rem; font-weight: bold; }

        /* --- UI BUTTONS --- */
        .btn-ui { background: rgba(0,0,0,0.6); border: 2px solid #fff; color: white; padding: 20px; font-weight: bold; cursor: pointer; font-size: 1.2rem; outline: none; }
        .btn-ui:active { background: #fff; color: #000; }
        
        #heater-btn { position: absolute; top: 30px; right: 30px; width: 180px; z-index: 100; border-color: #fff; }
        #heater-btn.on { background: rgba(255, 69, 0, 0.6); border-color: #ff4500; color: #ff4500; }

        #tab-trigger { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 400px; z-index: 1500; border-color: var(--neon); color: var(--neon); }

        /* --- MONITOR --- */
        #tablet { position: absolute; inset: 0; background: #000; z-index: 700; display: flex; flex-direction: column; align-items: center; justify-content: center; transform: translateY(105%); transition: transform var(--tablet-speed); }
        #tablet.up { transform: translateY(0%); }
        #cam-view { width: 95vw; height: 60vh; border: 6px solid #fff; background-size: 100% 100%; position: relative; background-color: #050505; }
        .cam-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 20px; width: 95vw; }

        /* --- JUMPSCARE ANIMATION --- */
        .js-layer { display: none; position: fixed; inset: 0; z-index: 10000; background: #000; overflow: hidden; }
        #js-img { 
            width: 110%; height: 110%; object-fit: cover; 
            position: absolute; bottom: -100%; left: -5%;
            transition: bottom 1s cubic-bezier(0.2, 0, 0.2, 1);
        }
        
        /* Oscillate & Blur */
        .oscillate { animation: shake 0.1s infinite alternate, motionBlur 0.1s infinite; }
        @keyframes shake { from { transform: translate(2px, 2px) rotate(0deg); } to { transform: translate(-2px, -2px) rotate(1deg); } }
        @keyframes motionBlur { 0% { filter: blur(0px); } 50% { filter: blur(4px); transform: skewX(2deg); } 100% { filter: blur(0px); } }

        .slide-left { transition: left 1s cubic-bezier(0.2, 0, 0.2, 1) !important; bottom: -5% !important; left: -100% !important; }
        .slide-left.active { left: -5% !important; }
    </style>
</head>
<body>

    <div id="loading-screen" style="display:none;">
        <h2 style="color:var(--neon)">PRELOADING ASSETS...</h2>
        <div class="progress-bar"><div id="progress-fill"></div></div>
    </div>

    <div id="setup-menu">
        <h1 style="color:red; font-size: 4rem; margin-bottom: 20px;">BFDI: NIGHT SHIFT</h1>
        <input type="file" id="zip-in" style="margin-bottom: 20px; color:white;">
        <div id="start-area" style="display:none;">
            <button class="btn-ui" style="width:300px; color:var(--neon); border-color:var(--neon);" onclick="launchGame()">START GAME</button>
        </div>
    </div>

    <div id="game-view">
        <div class="clock" id="clock-txt">12 AM</div>
        <button id="heater-btn" class="btn-ui" onmousedown="toggleHeater(true)" onmouseup="toggleHeater(false)" ontouchstart="toggleHeater(true)" ontouchend="toggleHeater(false)">HEATER</button>
        <canvas id="noise"></canvas>
        <div id="office"></div>
        
        <button class="btn-ui" style="position:absolute; left:30px; bottom:38%; width:150px;" onmousedown="lt('l',true)" onmouseup="lt('l',false)">LIGHT L</button>
        <button class="btn-ui" style="position:absolute; right:30px; bottom:38%; width:150px;" onmousedown="lt('r',true)" onmouseup="lt('r',false)">LIGHT R</button>
        
        <button id="tab-trigger" class="btn-ui" onclick="toggleTab()">MONITOR</button>

        <div id="tablet">
            <div id="cam-view"><div id="cam-tag" style="padding:10px; background:rgba(0,0,0,0.8); border:1px solid #fff; position:absolute; top:10px; left:10px;">CAM 1</div></div>
            <div class="cam-grid">
                <button class="btn-ui" onclick="goCam('l','LEFT HALL')">CAM 1</button>
                <button class="btn-ui" onclick="goCam('r','RIGHT HALL')">CAM 2</button>
                <button class="btn-ui" onclick="goCam('s','SUPPLY CLOSET')">CAM 3</button>
                <button class="btn-ui" onclick="goCam('p','PARTS/SERVICE')">CAM 4</button>
            </div>
        </div>
    </div>

    <div id="js-layer" class="js-layer"><img id="js-img" src=""></div>

    <script>
        let assets = {}, active = false, tab = false, cur = 'l', heater = false, heatTime = 0;
        let clockSecs = 0, scPlayer = new Audio();
        let state = {
            f: { pos: 'hall', time: 0 }, // Firey
            c: { time: 0 },             // Clock
            m: { pos: 'closet', time: 0 }, // Marker
            b: { pos: 'closet', time: 0 }, // Book
            t: { pos: 'hall', time: 0 },   // Teardrop
            g: { time: 0 },              // Gelatin
            l: { active: false }         // Leafy
        };

        const ZIP = document.getElementById('zip-in');
        ZIP.onchange = async (e) => {
            document.getElementById('loading-screen').style.display = 'flex';
            const zip = await JSZip.loadAsync(e.target.files[0]);
            const files = Object.keys(zip.files);
            let loaded = 0;

            for (let f of files) {
                if (f.endsWith('.png') || f.endsWith('.webp') || f.endsWith('.mp3')) {
                    const blob = await zip.file(f).async("blob");
                    assets[f] = URL.createObjectURL(blob);
                }
                loaded++;
                document.getElementById('progress-fill').style.width = (loaded / files.length * 100) + '%';
            }
            if (assets['JumpscareAudio.mp3']) scPlayer.src = assets['JumpscareAudio.mp3'];
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('start-area').style.display = 'block';
        };

        function launchGame() {
            active = true;
            document.getElementById('setup-menu').classList.add('fade-out');
            document.getElementById('game-view').style.display = 'block';
            document.getElementById('game-view').classList.add('fade-in');
            document.getElementById('office').style.backgroundImage = `url(${assets['Office.png']})`;
            
            // AI Loop
            setInterval(() => {
                if (!active) return;
                clockSecs++;
                document.getElementById('clock-txt').innerText = Math.floor(clockSecs/60) + " AM";
                if(heater) heatTime++; else heatTime = 0;

                // Firey Logic
                if (state.f.pos === 'hall') {
                    state.f.time++;
                    if (state.f.time > 30) state.f.pos = 'near';
                }

                // Clock Logic
                if (cur !== 'p' || !tab) state.c.time++;
                else state.c.time = 0;
                if (state.c.time > 30 && assets['PartsorServiceGameOver.webp']) {
                    // Handled in renderCams
                }

                // Marker Logic
                if (state.m.pos === 'closet') {
                    state.m.time++;
                    if (state.m.time > 30) state.m.pos = 'hall';
                }
                if (state.m.pos === 'hall' && !heater) {
                    state.m.time++;
                    if (state.m.time > 50) triggerJS('MarkerJumpscare.png');
                } else if (state.m.pos === 'hall' && heater && heatTime > 6) {
                    state.m.pos = 'gone';
                }

                // Teardrop Logic
                if (cur === 'l' && tab) {
                    state.t.time++;
                    if (state.t.time > 28 && !heater) {
                        setTimeout(() => triggerJS('TeardropJumpscare.png', 'left'), 2000);
                    }
                }

                // Gelatin
                state.g.time++;
                if (state.g.time > 50 && (!heater || heatTime < 10)) triggerJS('GelatinJumpscare.png');

                // Book
                if (cur === 's' && tab) {
                    state.b.time++;
                    if (state.b.time > 30) state.b.pos = 'gone';
                }
                if (state.b.pos === 'gone') {
                    state.b.time++;
                    if (state.b.time > 5 && !rightLightOn) triggerJS('BookJumpscare.png');
                }
                
                // Flower (Random)
                if (Math.random() < 0.01) triggerJS('FlowerJumpscare.png');

            }, 1000);
            renderCams();
            drawStatic();
        }

        function toggleTab() {
            tab = !tab;
            document.getElementById('tablet').classList.toggle('up', tab);
            if (!tab) { 
                // Delay clearing certain states when monitor put down
            }
            renderCams();
        }

        function goCam(id, tag) {
            cur = id;
            document.getElementById('cam-tag').innerText = tag;
            renderCams();
        }

        function renderCams() {
            const v = document.getElementById('cam-view');
            let img = assets['LeftHallEmpty.webp'];

            if (cur === 'l') {
                img = assets['LeftHallEmpty.webp'];
                if (state.f.pos === 'hall') img = assets['FireyLeftHall.png'];
                if (state.f.pos === 'near') img = assets['FireyNearLeftHall.png'];
                if (Math.random() < 0.8) img = assets['LeafyLeftHall.png']; // Leafy Priority
            } else if (cur === 'r') {
                img = assets['RightHallEmpty.webp'];
                if (state.m.pos === 'hall') img = assets['MarkerRightHall.png'];
                if (state.g.time > 10) img = assets['GelatinRightHall.png'];
            } else if (cur === 's') {
                img = assets['SupplyClosetEmpty.webp'];
                if (state.m.pos === 'closet') img = assets['SupplyClosetMarker.png'];
                if (state.b.pos === 'closet') img = assets['BookSupplyCloset.png'];
            } else if (cur === 'p') {
                img = assets['ClockPartsorService.png'];
                if (state.c.time > 30) {
                    img = assets['PartsorServiceGameOver.webp'];
                    setTimeout(() => { if(state.c.time > 30) triggerJS('ClockJumpscare.png'); }, 4000);
                }
            }
            v.style.backgroundImage = `url(${img})`;
        }

        let rightLightOn = false;
        function lt(side, on) {
            if (tab) return;
            const off = document.getElementById('office');
            if (side === 'r') rightLightOn = on;
            
            let bg = assets['Office.png'];
            if (on) bg = assets[side === 'l' ? 'OfficeLeftLight.png' : 'OfficeRightLight.png'];
            
            // Firey Logic at Door
            if (side === 'l' && on && state.f.pos === 'near') {
                bg = assets['FireyLeftwithLight.png'];
                setTimeout(() => triggerJS('FireyJumpscare.png'), 2000);
            }
            
            off.style.backgroundImage = `url(${bg})`;
        }

        function toggleHeater(on) {
            heater = on;
            document.getElementById('heater-btn').classList.toggle('on', on);
        }

        function triggerJS(file, dir = 'up') {
            if (!active) return;
            active = false;
            // Force monitor down
            document.getElementById('tablet').classList.remove('up');
            
            const layer = document.getElementById('js-layer');
            const img = document.getElementById('js-img');
            layer.style.display = 'block';
            img.src = assets[file];
            img.classList.add('oscillate');
            
            if (dir === 'left') {
                img.classList.add('slide-left');
                setTimeout(() => img.classList.add('active'), 100);
            } else {
                setTimeout(() => img.style.bottom = '0', 100);
            }

            if (scPlayer.src) scPlayer.play();
            setTimeout(() => location.reload(), 4000);
        }

        function drawStatic() {
            const c = document.getElementById('noise'), ctx = c.getContext('2d');
            c.width = window.innerWidth; c.height = window.innerHeight;
            function loop() {
                if (!active) return;
                const d = ctx.createImageData(c.width, c.height), b = new Uint32Array(d.data.buffer);
                for (let i=0; i<b.length; i++) b[i] = Math.random() < 0.5 ? 0x25FFFFFF : 0;
                ctx.putImageData(d, 0, 0);
                requestAnimationFrame(loop);
            } loop();
        }
    </script>
</body>
</html>
