<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BFDI's Night Shift</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root { --osc-strength: 8px; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: black; overflow: hidden; font-family: 'Courier New', monospace; color: white; }

        /* --- UI LAYERS --- */
        #loading-screen { position: absolute; inset: 0; background: #000; z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        #game-view { position: relative; width: 100vw; height: 100vh; display: none; opacity: 0; transition: opacity 2s; }
        #office { width: 100%; height: 100%; background-size: cover; background-position: center; transition: filter 0.1s; }
        
        /* --- NOISE CANVAS (The Glitch Effect) --- */
        #noise { 
            position: absolute; inset: 0; z-index: 9000; pointer-events: none; 
            opacity: 0.25; /* Default Opacity */
            mix-blend-mode: screen; 
            transition: opacity 0.1s; /* Fast transition for the glitch */
        }

        /* --- BUTTONS --- */
        .ui-btn { 
            position: absolute; background: rgba(0,0,0,0.5); border: 2px solid white; color: white; 
            padding: 15px; font-weight: bold; border-radius: 4px; cursor: pointer; z-index: 50;
            font-size: 1rem;
        }
        .ui-btn:active { background: rgba(255,255,255,0.3); }
        #btn-l { left: 20px; bottom: 40%; }
        #btn-r { right: 20px; bottom: 40%; }
        #btn-heater { top: 20px; right: 20px; border-style: dashed; border-color: red; color: red; }
        #btn-heater.active { background: red; color: black; }
        #btn-cam-toggle { bottom: 20px; left: 50%; transform: translateX(-50%); width: 250px; }

        /* --- MONITOR --- */
        #monitor { 
            position: absolute; left: 0; width: 100%; height: 100%; bottom: -110%;
            background: rgba(0,0,0,0.95); z-index: 1000; transition: bottom 0.5s cubic-bezier(0.2, 0.8, 0.2, 1);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        #monitor.active { bottom: 0; }
        #cam-viewport { width: 85vw; height: 55vh; border: 3px solid #fff; background-size: cover; background-position: center; position: relative; margin-bottom: 15px; }
        .cam-map { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; width: 90vw; }
        .cam-btn { padding: 10px; background: #222; border: 1px solid #555; color: #fff; }
        .cam-btn.selected { border-color: #0f0; color: #0f0; }

        /* --- JUMPSCARES --- */
        #js-container { display: none; position: absolute; inset: 0; z-index: 9500; overflow: hidden; pointer-events: none; }
        #js-img { position: absolute; width: 100%; height: 100%; object-fit: contain; }
        
        /* Slide Up (Standard) */
        .anim-up { animation: slideUp 1s cubic-bezier(0.1, 0.9, 0.2, 1) forwards, oscillate 0.05s infinite; filter: blur(5px); }
        @keyframes slideUp { 0% { bottom: -100%; filter: blur(20px) skewY(10deg); } 100% { bottom: 0; filter: blur(0px) skewY(0deg); } }
        
        /* Slide Left (Teardrop) */
        .anim-left { animation: slideLeft 1s cubic-bezier(0.1, 0.9, 0.2, 1) forwards, oscillate 0.05s infinite; }
        @keyframes slideLeft { 0% { left: -100%; filter: blur(20px) skewX(-10deg); } 100% { left: 0; filter: blur(0px) skewX(0deg); } }

        @keyframes oscillate { 
            0% { transform: translate(var(--osc-strength), var(--osc-strength)); }
            25% { transform: translate(calc(var(--osc-strength) * -1), var(--osc-strength)); }
            50% { transform: translate(calc(var(--osc-strength) * -1), calc(var(--osc-strength) * -1)); }
            75% { transform: translate(var(--osc-strength), calc(var(--osc-strength) * -1)); }
            100% { transform: translate(var(--osc-strength), var(--osc-strength)); }
        }
    </style>
</head>
<body>

    <div id="loading-screen">
        <h1 style="color:red; font-size: 2rem;">BFDI'S NIGHT SHIFT</h1>
        <p>Please upload <b>assets.zip</b></p>
        <input type="file" id="zip-input" accept=".zip" style="color:white;">
        <p id="status" style="margin-top:20px; font-size: 0.8rem; color: #888;">Waiting for file...</p>
    </div>

    <div id="game-view">
        <canvas id="noise"></canvas>
        <div id="office"></div>
        <div style="position:absolute; top:15px; left:20px; font-size:1.5rem; z-index:60;" id="clock-display">12 AM</div>
        
        <button id="btn-l" class="ui-btn" ontouchstart="light('l',true)" ontouchend="light('l',false)" onmousedown="light('l',true)" onmouseup="light('l',false)">LIGHT L</button>
        <button id="btn-r" class="ui-btn" ontouchstart="light('r',true)" ontouchend="light('r',false)" onmousedown="light('r',true)" onmouseup="light('r',false)">LIGHT R</button>
        <button id="btn-heater" class="ui-btn" ontouchstart="heater(true)" ontouchend="heater(false)" onmousedown="heater(true)" onmouseup="heater(false)">HEATER</button>
        <button id="btn-cam-toggle" class="ui-btn" onclick="toggleMonitor()">MONITOR</button>

        <div id="monitor">
            <div id="cam-viewport">
                <div style="position:absolute; top:10px; left:10px; background:black; padding:5px; border:1px solid white;" id="cam-name">CAM 01</div>
            </div>
            <div class="cam-map">
                <button class="cam-btn" onclick="setCam('left', 'Left Hall', this)">LEFT HALL</button>
                <button class="cam-btn" onclick="setCam('right', 'Right Hall', this)">RIGHT HALL</button>
                <button class="cam-btn" onclick="setCam('closet', 'Supply Closet', this)">SUPPLY CLOSET</button>
                <button class="cam-btn" onclick="setCam('parts', 'Parts/Service', this)">PARTS/SERVICE</button>
            </div>
        </div>

        <div id="js-container"><img id="js-img" src=""></div>
    </div>

    <script>
        // --- ASSET MAPPING ---
        const zipMap = {
            off: "Office.png", offL: "OfficeLeftLight.png", offR: "OfficeRightLight.png",
            fLight: "FireyLeftwithLight.png", fHall: "FireyLeftHall.png", fDoor: "FireyNearLeftHallDoor.png", fJS: "FireyJumpscare.png",
            cParts: "ClockPartsorService.png", cDanger: "PartsorServiceGameOver.webp", cJS: "ClockJumpscare.png",
            rEmpty: "RightHallEmpty.webp", lEmpty: "LeftHallEmpty.webp", mHall: "MarkerRightHall.png",
            mCloset: "SupplyClosetMarker.png", mJS: "MarkerJumpscare.png", clEmpty: "SupplyClosetEmpty.webp",
            tdHall: "TeardropLeftHall.png", tdRun: "TeardropRun.png", tdJS: "TeardropJumpscare.png",
            bCloset: "BookSupplyCloset.png", bJS: "BookJumpscare.png", gHall: "GelatinRightHall.png",
            gJS: "GelatinJumpscare.png", lHall: "LeafyLeftHall.png", lJS: "LeafyJumpscare.png",
            lfHall: "LeafyandFireyLeftHall.png", flJS: "FlowerJumpscare.png", sfx: "JumpscareAudio.mp3"
        };

        let assets = {};
        let sc = new Audio();
        let active = false, mon = false, heat = false;
        let curCam = 'left';
        let hour = 0;

        // --- AI VARIABLES ---
        let clockState = 0; // 0=Safe, 1=Gone, 2=Danger
        let markerLoc = 0; // 0=Closet, 1=RightHall
        let markerTimer = 0;
        let bookActive = false;
        let tdState = 0; // 0=Hall, 1=Run
        let fireyState = 0; // 0=Hall, 1=NearDoor

        // --- PRELOADER ---
        document.getElementById('zip-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if(!file) return;
            
            document.getElementById('status').innerText = "Unpacking Assets...";
            const zip = await JSZip.loadAsync(file);
            
            for(let [key, name] of Object.entries(zipMap)) {
                const f = zip.file(name);
                if(f) {
                    const b = await f.async("blob");
                    assets[key] = URL.createObjectURL(b);
                } else {
                    console.warn("Missing file:", name);
                }
            }
            
            if(assets.sfx) sc.src = assets.sfx;

            document.getElementById('status').innerText = "Done! Starting...";
            setTimeout(startGame, 1000);
        });

        function startGame() {
            document.getElementById('loading-screen').style.display = 'none';
            document.getElementById('game-view').style.display = 'block';
            setTimeout(() => document.getElementById('game-view').style.opacity = 1, 100);
            
            document.getElementById('office').style.backgroundImage = `url('${assets.off}')`;
            active = true;
            
            noise();
            startAI();
            startClock();
        }

        // --- GAMEPLAY CONTROLS ---
        function toggleMonitor() {
            if(!active) return;
            mon = !mon;
            document.getElementById('monitor').classList.toggle('active', mon);
            if(mon) updateCam();
        }

        function setCam(c, name, btn) {
            curCam = c;
            document.getElementById('cam-name').innerText = name;
            document.querySelectorAll('.cam-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            updateCam();
            
            // Clock Logic: Leaving camera logic
            if(c !== 'parts' && clockState === 0) {
                // Logic handled in AI Loop
            }
        }

        function light(s, on) {
            if(mon || !active) return;
            if(!on) { document.getElementById('office').style.backgroundImage = `url('${assets.off}')`; return; }
            
            // Firey Logic
            if(s === 'l' && fireyState === 1) {
                document.getElementById('office').style.backgroundImage = `url('${assets.fLight}')`;
                setTimeout(() => doJumpscare('f'), 2000); // 2s delay then death
            } else {
                document.getElementById('office').style.backgroundImage = `url('${s==='l' ? assets.offL : assets.offR}')`;
            }
        }

        function heater(on) {
            heat = on;
            const btn = document.getElementById('btn-heater');
            if(on) btn.classList.add('active');
            else btn.classList.remove('active');
        }

        // --- VISUALS ---
        function updateCam() {
            const v = document.getElementById('cam-viewport');
            let img = assets.lEmpty;

            if(curCam === 'left') {
                if(fireyState === 0) img = assets.fHall; // Medium chance logic to be added
                else if(tdState === 0) img = assets.tdHall; 
                else if(tdState === 1) img = assets.tdRun;
                else img = assets.lEmpty;
            } 
            else if (curCam === 'right') {
                img = (markerLoc === 1) ? assets.mHall : assets.rEmpty;
            }
            else if (curCam === 'closet') {
                img = (markerLoc === 0) ? assets.mCloset : assets.clEmpty;
                if(bookActive) img = assets.bCloset;
            }
            else if (curCam === 'parts') {
                img = (clockState === 2) ? assets.cDanger : assets.cParts;
            }

            v.style.backgroundImage = `url('${img}')`;
        }

        // --- GLITCH EFFECT ---
        function triggerGlitch() {
            const n = document.getElementById('noise');
            n.style.opacity = '1'; // MAX OPACITY
            setTimeout(() => {
                n.style.opacity = '0.25'; // RESTORE AFTER 1s
            }, 1000);
        }

        // --- AI LOGIC LOOP ---
        function startAI() {
            // Teardrop Logic
            setInterval(() => {
                if(!active) return;
                // Simplified: If in left hall for too long
                if(Math.random() < 0.2) {
                    tdState = 1; // Run Phase
                    if(mon && curCam === 'left') {
                        updateCam(); // Show Run Image
                        setTimeout(() => {
                            triggerGlitch();
                            setTimeout(() => {
                                if(!heat) doJumpscare('td'); // Jumpscare if heater off
                            }, 1000);
                        }, 2000);
                    }
                }
            }, 10000);

            // Clock Logic
            setInterval(() => {
                if(!active) return;
                if(curCam === 'parts' && mon) {
                    // Watching...
                } else {
                    // Not watching for 30s logic handled here
                    if(Math.random() < 0.1) clockState = 2; // Danger Mode
                }
                
                if(clockState === 2 && curCam === 'parts' && mon) {
                    // Player saw danger
                    setTimeout(() => doJumpscare('c'), 4000);
                }
            }, 5000);
        }

        function startClock() {
            setInterval(() => {
                if(!active) return;
                hour++;
                if(hour === 6) {
                    active = false;
                    document.getElementById('loading-screen').style.display = 'flex';
                    document.getElementById('loading-screen').innerHTML = "<h1 style='color:green; font-size:4rem'>6 AM</h1>";
                }
                document.getElementById('clock-display').innerText = hour + " AM";
            }, 60000); // 1 minute = 1 hour
        }

        function doJumpscare(char) {
            if(!active) return;
            active = false;
            mon = false; 
            document.getElementById('monitor').classList.remove('active');
            
            const c = document.getElementById('js-container');
            const i = document.getElementById('js-img');
            
            // Map char code to asset
            i.src = assets[char+'JS'] || assets.fJS;
            
            c.style.display = 'block';
            
            // Apply specific animations
            if(char === 'td') i.className = 'anim-left'; // Teardrop Slides Left
            else i.className = 'anim-up'; // Standard Slide Up
            
            sc.loop = true;
            sc.currentTime = 0;
            sc.play();
            
            setTimeout(() => location.reload(), 3500);
        }

        function noise() {
            const c = document.getElementById('noise'), x = c.getContext('2d');
            const resize = () => { c.width = window.innerWidth/4; c.height = window.innerHeight/4; };
            window.addEventListener('resize', resize); resize();
            
            const loop = () => {
                const id = x.createImageData(c.width, c.height);
                const d = new Uint32Array(id.data.buffer);
                for(let i=0; i<d.length; i++) {
                    // Random static
                    d[i] = (Math.random() < 0.5) ? 0xFF000000 : 0x00000000; 
                }
                x.putImageData(id, 0, 0);
                requestAnimationFrame(loop);
            }; loop();
        }
    </script>
</body>
    </html>
